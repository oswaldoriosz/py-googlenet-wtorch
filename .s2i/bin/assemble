#!/bin/bash
set -e

# Version 1.8
# Directorio de trabajo
cd /tmp/src

# Verificar si g++ est치 instalado
if ! command -v g++ &> /dev/null; then
    echo "Error: g++ no est치 instalado"
    exit 1
fi

# Verificar la presencia de libtorch en el PVC
if [ ! -d "/data/libtorch" ]; then
    echo "Error: El directorio /data/libtorch no existe en el PVC"
    exit 1
fi
if [ ! -f "/data/libtorch/include/torch/script.h" ]; then
    echo "Error: torch/script.h no se encuentra en /data/libtorch/include/torch"
    ls -la /data/libtorch/include/torch
    exit 1
fi

# Verificar la presencia de wheels en el PVC
if [ ! -d "/data/wheels" ]; then
    echo "Error: El directorio /data/wheels no existe en el PVC"
    exit 1
fi

# Recombinar las partes de los wheels si est치n particionados
#for whl in /data/wheels/*.whl.part*; do
#    if [ -f "$whl" ]; then
#        base_whl=${whl%.part*}
#        if [ ! -f "$base_whl" ]; then
#            echo "Recombinando $base_whl..."
#            cat $base_whl.part* > $base_whl || {
#                echo "Error: No se pudo recombinar $base_whl"
#                exit 1
#            }
#        fi
#    fi
#done

# Instalar dependencias de Python desde los wheels en el PVC
pip install --no-index --find-links /data/wheels \
    fastapi==0.115.0 \
    uvicorn==0.30.6 \
    torch==2.4.1 \
    torchvision==0.19.1 \
    Pillow==10.4.0 \
    matplotlib==3.9.2 \
    pybind11==2.13.6 \
    python-multipart==0.0.9

# Compilar el m칩dulo C++ usando libtorch desde /data/libtorch
g++ -shared -fPIC -o googlenet.so main.cpp \
    -I/opt/app-root/lib64/python3.12/site-packages/pybind11/include \
    -I/data/libtorch/include \
    -I/data/libtorch/include/torch/csrc/api/include \
    -L/data/libtorch/lib \
    -ltorch -ltorch_cpu -lc10 \
    -std=c++17 \
    -Wl,-rpath,/data/libtorch/lib

# Copiar los archivos necesarios al directorio de runtime
mkdir -p /opt/app-root/src/data
cp googlenet.so main.py /opt/app-root/src/
cp /data/googlenet.pt /opt/app-root/src/data/
cp /data/imagenet_classes.txt /opt/app-root/src/data/

# Configurar permisos
chown -R 1001:0 /opt/app-root/src
chmod -R g+w /opt/app-root/src
chmod +x /opt/app-root/src/main.py
