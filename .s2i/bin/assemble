#!/bin/bash
set -e

# Version 2.0
# Directorio de trabajo
cd /tmp/src

# Verificar si g++ está instalado
if ! command -v g++ &> /dev/null; then
    echo "Error: g++ no está instalado"
    exit 1
fi

# Verificar la presencia de libtorch en el PVC
echo "Verificando contenido del PVC en /data..."
ls -lh /data || echo "Error: No se pudo listar /data"
if [ ! -d "/data/libtorch" ]; then
    echo "Error: El directorio /data/libtorch no existe en el PVC"
    exit 1
fi
if [ ! -f "/data/libtorch/include/torch/script.h" ]; then
    echo "Error: torch/script.h no se encuentra en /data/libtorch/include/torch"
    ls -la /data/libtorch/include/torch
    exit 1
fi

# Verificar la presencia de wheels en el PVC
echo "Verificando directorio de wheels en /data/wheels..."
ls -lh /data/wheels || echo "Error: No se pudo listar /data/wheels"
if [ ! -d "/data/wheels" ]; then
    echo "Error: El directorio /data/wheels no existe en el PVC"
    exit 1
fi

# Instalar dependencias de Python desde los wheels en el PVC
echo "Instalando dependencias desde /data/wheels..."
pip install --no-index --find-links /data/wheels \
    fastapi==0.115.0 \
    uvicorn==0.30.6 \
    torch==2.4.1 \
    torchvision==0.19.1 \
    Pillow==10.4.0 \
    matplotlib==3.9.2 \
    pybind11==2.13.6 \
    python-multipart==0.0.9

# Compilar el módulo C++ usando libtorch desde /data/libtorch
echo "Compilando googlenet.so..."
g++ -shared -fPIC -o googlenet.so main.cpp \
    -I/opt/app-root/lib64/python3.12/site-packages/pybind11/include \
    -I/data/libtorch/include \
    -I/data/libtorch/include/torch/csrc/api/include \
    -L/data/libtorch/lib \
    -ltorch -ltorch_cpu -lc10 \
    -std=c++17 \
    -Wl,-rpath,/data/libtorch/lib

# Copiar los archivos necesarios al directorio de runtime
echo "Copiando archivos al directorio de runtime..."
mkdir -p /opt/app-root/src/data
cp googlenet.so main.py /opt/app-root/src/
cp /data/googlenet.pt /opt/app-root/src/data/
cp /data/imagenet_classes.txt /opt/app-root/src/data/

# Configurar permisos
echo "Configurando permisos..."
chown -R 1001:0 /opt/app-root/src
chmod -R g+w /opt/app-root/src
chmod +x /opt/app-root/src/main.py
echo "Assemble completado exitosamente."
